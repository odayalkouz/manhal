Scratcher=function(){function t(t){var e,n={},i=t.originalEvent;return void 0!=i.changedTouches?(e=i.changedTouches[0],n.pageX=e.pageX,n.pageY=e.pageY):(n.pageX=t.pageX,n.pageY=t.pageY),n}function e(t,e){var n=$(t).offset();return{x:e.pageX-n.left,y:e.pageY-n.top}}function n(t,e,n){this.canvas={main:$("#"+t).get(0),temp:null,draw:null},this.mouseDown=!1,this.canvasId=t,this._setupCanvases(),this.setImages(e,n),this._eventListeners={}}return n.prototype.setImages=function(t,e){this.image={back:{url:t,img:null},front:{url:e,img:null}},t&&e&&this._loadImages()},n.prototype.fullAmount=function(t){var e,n,i,a,s,o=this.canvas.draw,r=o.getContext("2d");for((!t||t<1)&&(t=1),t*=4,a=(n=(s=r.getImageData(0,0,o.width,o.height).data).length)/t|0,e=i=0;e<n;e+=t)0!=s[e]&&i++;return i/a},n.prototype.recompositeCanvases=function(){var t=this.canvas.temp.getContext("2d"),e=this.canvas.main.getContext("2d");this.canvas.temp.width=this.canvas.temp.width,t.drawImage(this.canvas.draw,0,0),t.globalCompositeOperation="source-atop",t.drawImage(this.image.back.img,0,0),e.drawImage(this.image.front.img,0,0),e.drawImage(this.canvas.temp,0,0)},n.prototype.scratchLine=function(t,e,n){var i=this.canvas.draw.getContext("2d");i.lineWidth=30,i.lineCap=i.lineJoin="round",i.strokeStyle="#f00",n&&(i.beginPath(),i.moveTo(t+.01,e)),i.lineTo(t,e),i.stroke(),this.dispatchEvent(this.createEvent("scratch"))},n.prototype._setupCanvases=function(){var n=this.canvas.main;function i(i){var a=e(n,t(i));return this.mouseDown=!0,this.scratchLine(a.x,a.y,!0),this.recompositeCanvases(),this.dispatchEvent(this.createEvent("scratchesbegan")),!1}function a(i){if(!this.mouseDown)return!0;var a=e(n,t(i));return this.scratchLine(a.x,a.y,!1),this.recompositeCanvases(),!1}function s(t){return!this.mouseDown||(this.mouseDown=!1,this.dispatchEvent(this.createEvent("scratchesended")),!1)}this.canvas.temp=document.createElement("canvas"),this.canvas.draw=document.createElement("canvas"),this.canvas.temp.width=this.canvas.draw.width=n.width,this.canvas.temp.height=this.canvas.draw.height=n.height,$(n).on("mousedown",i.bind(this)).on("touchstart",i.bind(this)),$(document).on("mousemove",a.bind(this)),$(document).on("touchmove",a.bind(this)),$(document).on("mouseup",s.bind(this)),$(document).on("touchend",s.bind(this))},n.prototype.reset=function(){this.canvas.draw.width=this.canvas.draw.width,this.recompositeCanvases(),this.dispatchEvent(this.createEvent("reset"))},n.prototype.mainCanvas=function(){return this.canvas.main},n.prototype._loadImages=function(){var t=0;function e(e){++t>=2&&(this.dispatchEvent(this.createEvent("imagesloaded")),this.reset())}for(k in this.image)this.image.hasOwnProperty(k)&&(this.image[k].img=document.createElement("img"),$(this.image[k].img).on("load",e.bind(this)),this.image[k].img.src=this.image[k].url)},n.prototype.createEvent=function(t){return{type:t,target:this,currentTarget:this}},n.prototype.addEventListener=function(t,e){var n=this._eventListeners;t=t.toLowerCase(),n.hasOwnProperty(t)||(n[t]=[]),-1==n[t].indexOf(e)&&n[t].push(e)},n.prototype.removeEventListener=function(t,e){var n,i=this._eventListeners;t=t.toLowerCase(),i.hasOwnProperty(t)&&(e?-1!=(n=i[t].indexOf(e))&&i[t].splice(n,1):i[t]=[])},n.prototype.dispatchEvent=function(t){var e,n,i=this._eventListeners,a=t.type.toLowerCase();if(i.hasOwnProperty(a))for(n=i[a].length,e=0;e<n;e++)i[a][e].call(this,t)},Function.prototype.bind||(Function.prototype.bind=function(t){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var e=Array.prototype.slice.call(arguments,1),n=this,i=function(){},a=function(){return n.apply(this instanceof i?this:t||window,e.concat(Array.prototype.slice.call(arguments)))};return i.prototype=this.prototype,a.prototype=new i,a}),n}();